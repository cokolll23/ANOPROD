!function(){var t=BX.namespace("BX.Intranet.UserProfile");t.Tags||(t.Tags=function(t){return this.init(t),this},t.Tags.prototype={init:function(t){this.tagsLoader=null,this.tagsLoaderNode=BX("intranet-user-profile-tags-loader"),this.managerInstance=t.managerInstance,this.inputNode=t.inputNode,this.tagsNode=t.tagsNode,this.popup=null,this.popupContent=null,this.defferedTags=[],this.container={input:null,inputWrapper:null},this.popupContainer=null,this.initialized=null,this.tagsUsersPopupInstanceList={},this.getTagsData(),this.containerNode=BX("intranet-user-profile-tags-container"),this.editLinkNode=BX("intranet-user-profile-add-tags"),this.stubButtonNode=BX("intranet-user-profile-interests-stub-button"),this.editLinkNode&&BX.bind(this.editLinkNode,"click",this.show.bind(this)),this.stubButtonNode&&BX.bind(this.stubButtonNode,"click",this.show.bind(this)),BX.bind(window,"click",function(t){if(!BX.findParent(t.target,{className:"intranet-user-profile-tags-input-wrapper"})&&!BX.findParent(t.target,{className:"intranet-user-profile-tags-popup"})&&t.target!==this.editLinkNode&&t.target!==this.stubButtonNode){if(0<this.defferedTags.length){for(var e=0;e<this.defferedTags.length;e++)this.addTag({tag:this.defferedTags[e]});this.reindexUser(),this.defferedTags=[]}this.cleanInput(),BX.cleanNode(this.getInputWrapper()),this.getInputWrapper().appendChild(this.getInput()),this.hide(),this.closePopup()}}.bind(this))},closePopup:function(){this.popup&&this.popup.close()},getTagsData:function(t){BX.addClass(this.tagsLoaderNode,"intranet-user-profile-loader-getdata"),this.tagsLoader=this.managerInstance.showLoader({node:this.tagsLoaderNode,loader:this.tagsLoader}),BX.ajax.runComponentAction(this.managerInstance.componentName,"getTagsList",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{}}}).then(function(t){this.managerInstance.hideLoader({node:this.tagsLoaderNode,loader:this.tagsLoader}),BX.removeClass(this.tagsLoaderNode,"intranet-user-profile-loader-getdata"),BX.type.isNotEmptyObject(t.data)&&this.showTagsList(t.data)}.bind(this),function(t){this.managerInstance.hideLoader({node:this.tagsLoaderNode,loader:this.tagsLoader}),BX.removeClass(this.tagsLoaderNode,"intranet-user-profile-loader-getdata")}.bind(this))},showTagsList:function(t,e){for(var s in t)t.hasOwnProperty(s)&&(s=this.getTagNode({tag:s,tagData:t[s],openListSlider:!0}),e?(this.tagsNode.insertBefore(s,e),BX.cleanNode(e,!0)):this.tagsNode.appendChild(s));this.checkEmptyTagsList()},getTagNode:function(e){var s=BX.create("DIV",{attrs:{"bx-data-user-tag":e.tag},props:{className:"intranet-user-profile-tags-item intranet-user-profile-tags-item-new"},children:[BX.create("DIV",{props:{className:"intranet-user-profile-tags-item-title",title:e.tag},text:e.tag,events:e.openListSlider?{click:function(){BX.SidePanel.Instance.open(decodeURIComponent(this.managerInstance.urls.PathToTag).replace("#TAG#",e.tag),{cacheable:!1,allowChangeHistory:!0,width:1e3})}.bind(this)}:null}),this.managerInstance.isOwnProfile?BX.create("DIV",{props:{className:"intranet-user-profile-tags-item-remove"},events:{click:function(t){this.removeTag({tag:e.tag,node:s}),this.reindexUser(),t.stopPropagation(),t.preventDefault()}.bind(this)}}):null,e.tagData?this.getTagUsersNode({tag:e.tag,checksum:e.tagData.CHECKSUM,usersObject:e.tagData.USERS}):null,e.tagData?this.getTagCounterNode(e.tagData.COUNT-e.tagData.USERS.length):null,e.tagData?BX.create("SPAN",{attrs:{id:"iup-tags-item-users-popup-container-"+e.tagData.CHECKSUM,style:"display: none;"},props:{className:"iup-tags-users-popup-cont"},children:[BX.create("SPAN",{props:{className:"iup-tags-item-users-popup-outer"},children:[BX.create("SPAN",{props:{className:"iup-tags-item-users-popup"},children:[BX.create("SPAN",{props:{className:"iup-tags-item-users-waiter"}})]}),BX.create("SPAN",{props:{className:"iup-tags-item-users-action"},children:[BX.create("SPAN",{props:{className:"ui-btn ui-btn-xs ui-btn-primary"},text:BX.message("INTRANET_USER_PROFILE_TAGS_POPUP_ADD")})]})]})]}):null]});return e.tagData&&(this.tagsUsersPopupInstanceList[e.tagData.CHECKSUM]=new t.TagsUsersPopup({containerNodeId:"iup-tags-item-users-popup-container-"+e.tagData.CHECKSUM,tagsInstance:this,tag:e.tag,tagNode:s,checksum:e.tagData.CHECKSUM})),BX.bind(s,"animationend",function(){s.classList.remove("intranet-user-profile-tags-item-new")}),s},removeTag:function(t){var e=BX.type.isNotEmptyObject(t)?BX(t.node):null,s=BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyString(t.tag)?t.tag:null;e&&BX.type.isNotEmptyString(s)&&(this.removeTagNode(e),BX.ajax.runComponentAction(this.managerInstance.componentName,"removeTag",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{tag:t.tag}}}).then(function(t){}.bind(this),function(t){}.bind(this)))},removeTagNode:function(t){t.style.opacity="0",BX.bind(t,"transitionend",function(){t.parentNode.removeChild(t),this.checkEmptyTagsList()}.bind(this))},checkEmptyTagsList:function(){this.setContainerEmpty(!this.tagsNode.hasChildNodes())},getTagUsersNode:function(e){for(var t=BX.create("DIV",{props:{className:"intranet-user-profile-tags-users"},events:{mouseenter:function(t){this.tagsUsersPopupInstanceList[e.checksum]&&this.tagsUsersPopupInstanceList[e.checksum].onMouseOver({event:t})}.bind(this),mouseleave:function(t){this.tagsUsersPopupInstanceList[e.checksum]&&this.tagsUsersPopupInstanceList[e.checksum].onMouseOut({event:t})}.bind(this),click:function(t){this.tagsUsersPopupInstanceList[e.checksum]&&this.tagsUsersPopupInstanceList[e.checksum].onClick({event:t})}.bind(this)}}),s=0;s<e.usersObject.length;s++){var a=e.usersObject[s];t.appendChild(BX.create("DIV",{props:{className:"ui-icon ui-icon-common-user intranet-user-profile-tags-user"},children:[BX.create("i",{style:BX.type.isNotEmptyString(a.PERSONAL_PHOTO_SRC)?{backgroundImage:"url('"+a.PERSONAL_PHOTO_SRC+"')"}:null})]}))}return t},getTagCounterNode:function(t){return 0<t?BX.create("DIV",{props:{className:"intranet-user-profile-tags-users-counter"},text:parseInt(t)}):null},addTag:function(e){BX.ajax.runComponentAction(this.managerInstance.componentName,"addTag",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{tag:e.tag,userId:void 0!==e.userId?parseInt(e.userId):null}}}).then(function(t){BX.type.isNotEmptyObject(t.data)&&this.showTagsList(t.data,BX.type.isDomNode(e.tagNode)?e.tagNode:null)}.bind(this),function(t){}.bind(this))},reindexUser:function(t){BX.type.isNotEmptyObject(t)||(t={}),setTimeout(function(){BX.ajax.runComponentAction(this.managerInstance.componentName,"reindexUser",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{userId:void 0!==t.userId?parseInt(t.userId):null}}}).then(function(t){}.bind(this),function(t){}.bind(this))}.bind(this),1e3)},getInputValue:function(){return this.getInput().value},cleanInput:function(){this.getInput().value=""},focusInput:function(){this.getInput().focus()},getInputWrapper:function(){return this.container.inputWrapper||(this.container.inputWrapper=BX.create("DIV",{props:{className:"intranet-user-profile-tags-input-wrapper"}}),this.container.inputWrapper.appendChild(this.getInput())),this.container.inputWrapper},parseLongString:function(){var t=this.getInputValue();if(""!==t){var e=t.split(/[\s\t]+/);if(BX.type.isArray(e)&&1<e.length){for(var s=0;s<e.length;s++)BX.type.isNotEmptyString(e[s])&&this.addDeferredTag(e[s],this.getTagNode({tag:e[s]}));return!0}}return!1},checkDeferredTag:function(t){return BX.util.in_array(t,this.defferedTags)},addDeferredTag:function(t,e){this.checkDeferredTag(t)||(this.defferedTags.push(t),this.addDeferredTagNode(e))},addDeferredTagNode:function(t){this.cleanInput(),this.getInputWrapper().insertBefore(BX.create("div",{props:{className:"intranet-user-profile-tags-input-deferred"},children:[t]}),this.getInputWrapper().children[this.getInputWrapper().children.length-1])},removeDeferredTag:function(t){-1!==this.defferedTags.indexOf(t)&&this.defferedTags.splice(this.defferedTags.indexOf(t),1)},removeDeferredTagNode:function(t){this.getInputWrapper().removeChild(t)},getInput:function(){return this.container.input||(this.container.input=BX.create("INPUT",{props:{type:"text",className:"intranet-user-profile-tags-input"},events:{keydown:function(t){if(t.code&&("enter"===t.code.toLowerCase()||"numpadenter"===t.code.toLowerCase())||t.keyCode&&13===t.keyCode){if((0!==this.defferedTags.length||""!==this.getInputValue())&&!this.parseLongString()){if(0<this.defferedTags.length){for(var e=0;e<this.defferedTags.length;e++)this.addTag({tag:this.defferedTags[e]});this.reindexUser(),this.defferedTags=[]}""!==this.getInputValue()&&(this.addTag({tag:this.getInputValue()}),this.reindexUser()),this.cleanInput(),BX.cleanNode(this.getInputWrapper()),this.getInputWrapper().appendChild(this.getInput()),this.hide(),this.closePopup()}}else t.code&&"escape"===t.code.toLowerCase()||t.keyCode&&27===t.keyCode?(this.hide(),this.cleanInput(),BX.cleanNode(this.getInputWrapper()),this.getInputWrapper().appendChild(this.getInput()),this.defferedTags=[],this.closePopup(),t.preventDefault(),t.stopPropagation()):t.code&&("arrowdown"===t.code.toLowerCase()||"arrowup"===t.code.toLowerCase())||t.keyCode&&(38===t.keyCode||40===t.keyCode)||((t.code&&"space"===t.code.toLowerCase()||t.keyCode&&32===t.keyCode)&&""!==this.getInputValue()?(this.parseLongString()||this.addDeferredTag(this.getInputValue(),this.getTagNode({tag:this.getInputValue()})),this.cleanInput(),BX.PreventDefault(t)):(t.code&&"backspace"===t.code.toLowerCase()||t.keyCode&&8===t.keyCode)&&""===this.getInputValue()&&0<this.defferedTags.length&&(t=this.getInputWrapper().children[this.getInputWrapper().children.length-2],this.removeDeferredTag(this.defferedTags[this.defferedTags.length-1]),this.removeDeferredTagNode(t)))}.bind(this),input:BX.debounce(function(){""!==this.getInputValue()?BX.ajax.runComponentAction(this.managerInstance.componentName,"searchTags",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{searchString:this.getInputValue()}}}).then(function(t){BX.type.isNotEmptyObject(t.data)?this.getPopup({tags:t.data,mode:"search"}).show():this.closePopup()}.bind(this),function(t){this.closePopup()}.bind(this)):(this.getPopup().destroy(),this.popup=null)},1e3,this)}})),this.container.input},hide:function(){this.getInputWrapper().style.height=this.getInputWrapper().offsetHeight+"px",setTimeout(function(){this.getInputWrapper().classList.remove("intranet-user-profile-tags-input-show"),this.getInputWrapper().classList.add("intranet-user-profile-tags-hide"),this.getInputWrapper().style.height=null,this.setContainerEditMode(!1)}.bind(this)),this.initialized=!1},show:function(){this.initialized||this.inputNode.appendChild(this.getInputWrapper()),this.getInputWrapper().classList.remove("intranet-user-profile-tags-hide"),setTimeout(function(){this.setContainerEditMode(!0),this.getInputWrapper().classList.add("intranet-user-profile-tags-input-show"),setTimeout(function(){this.getInputWrapper().style.height="auto"}.bind(this),400)}.bind(this)),this.focusInput(),this.getPopularTags(),this.initialized=!0},getPopup:function(t){var e=this.getInput();return BX.type.isNotEmptyObject(t)||(t={}),this.popup?(this.popup.setContent(this.getPopupContainer(t)),this.popup.setBindElement(e)):this.popup=new BX.PopupWindow({className:"intranet-user-profile-tags-popup",bindElement:e,width:this.getInput().offsetWidth,content:this.getPopupContainer(t),animation:"fading-slide",offsetTop:5}),this.popup.setBindElement(e),this.popup},getPopupContainer:function(t){return this.popupContent=BX.create("div",{props:{className:"intranet-user-profile-tags-popup"},children:[this.getPopupContentEmpty(t)]}),this.popupContent},getPopularTags:function(){BX.ajax.runComponentAction(this.managerInstance.componentName,"searchTags",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{}}}).then(function(t){BX.type.isNotEmptyObject(t.data)&&setTimeout(function(){this.getPopup({tags:t.data,mode:"popular"}).show()}.bind(this),200)}.bind(this),function(t){}.bind(this))},getPopupContentEmpty:function(t){for(var e,s=BX.type.isNotEmptyString(t.mode)?t.mode:"popular",a=(this.popupContent=BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty-cont"}}),this.popupContainer=BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty"},children:[BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty-title"},text:BX.message("search"==s?"INTRANET_USER_PROFILE_TAGS_POPUP_SEARCH_TITLE":"INTRANET_USER_PROFILE_TAGS_POPUP_TITLE")}),this.popupContent,BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty-text"},text:BX.message("INTRANET_USER_PROFILE_TAGS_POPUP_HINT_3")})]}),BX.type.isNotEmptyObject(t)&&BX.type.isArray(t.tags)?t.tags:[]),n=null,i=0;i<a.length;i++)e=this.getTagNode({tag:a[i].NAME,tagData:a[i]}),BX.bind(e,"click",function(t){n=t.currentTarget.getAttribute("bx-data-user-tag"),BX.type.isNotEmptyString(n)&&this.addDeferredTag(n,this.getTagNode({tag:n})),this.focusInput()}.bind(this)),this.popupContent.appendChild(e);return this.popupContainer},getTagList:function(){for(var t=this.tags,e=BX.create("DIV",{props:{className:"intranet-user-profile-tags-popup-list"}}),s=0;s<t.length;s++){var a=BX.create("DIV",{attrs:{"bx-data-user-tag":t[s].text},props:{className:"intranet-user-profile-tags-popup-list-item"},text:t[s].text,events:{click:function(t){this.addTag({tag:t.currentTarget.getAttribute("bx-data-user-tag")}),this.reindexUser(),this.cleanInput(),this.closePopup()}.bind(this)}});e.appendChild(a)}return e},setActivePopularTag:function(t){t.classList.add("intranet-user-profile-tags-item-active")},resetActivePopularTag:function(t){t.classList.remove("intranet-user-profile-tags-item-active")},setInputValue:function(t){this.getInput().value=t},setContainerEmpty:function(t){this.containerNode&&(t?BX.addClass(this.containerNode,"intranet-user-profile-container-empty"):BX.removeClass(this.containerNode,"intranet-user-profile-container-empty"))},setContainerEditMode:function(t){this.containerNode&&(t?BX.addClass(this.containerNode,"intranet-user-profile-container-editmode"):BX.removeClass(this.containerNode,"intranet-user-profile-container-editmode"))}})}();