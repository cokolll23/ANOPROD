!function(){var t=BX.namespace("BX.Intranet.UserProfile");t.EntityEditor||(t.EntityEditor=function(t){this.init(t)},t.EntityEditor.prototype={init:function(t){var e=t.params;this.managerInstance=t.managerInstance,this.signedParameters=e.signedParameters,this.componentName=e.componentName,this.initialFields=e.initialFields||{},this.isCloud="Y"===e.isCloud,this.isCurrentUserAdmin="Y"===e.isCurrentUserAdmin,this.gridId=e.gridId||null,this.voximplantEnablePhones=e.voximplantEnablePhones,BX.addCustomEvent("BX.UI.EntityEditorControlFactory:onInitialize",BX.proxy(function(t,e){e.methods.timezone=this.userProfileEntity.bind(this),e.methods.phone=this.userProfileEntity.bind(this)},this)),BX.addCustomEvent("BX.UI.EntityEditorAjax:onSubmit",BX.proxy(function(t){this.onAfterSubmit(t)},this)),!this.isCloud&&this.isCurrentUserAdmin&&(BX.addCustomEvent(window,"BX.UI.EntityEditor:onPrepareConfigMenuItems",function(t,e){e.push({id:"intranet-fields-link",text:BX.message("INTRANET_USER_FIILDS_SETTINGS"),onclick:function(){this.showFieldsSettings()}.bind(this),className:"menu-popup-item-none"})}.bind(this)),BX.addCustomEvent(window,"BX.UI.EntityEditor:onUserFieldAdd",function(t,e){"object"==typeof e&&e&&BX.ajax.runComponentAction(this.componentName,"onUserFieldAdd",{signedParameters:this.signedParameters,mode:"ajax",data:{fieldName:e.FIELD}}).then(function(t){},function(t){})}.bind(this)))},userProfileEntity:function(t,e,i){return"timezone"===t?BX.Intranet.UserProfile.EntityEditorTimezone.create(e,i):"phone"===t?(i.model._settings.SHOW_PHONE_ICON="Y"==this.voximplantEnablePhones[e]?"Y":"N",BX.Intranet.UserProfile.EntityEditorPhone.create(e,i)):null},onAfterSubmit:function(t){this.isCloud&&(e=BX.prop.getString(t,"PERSONAL_MOBILE",""))&&this.initialFields.PERSONAL_MOBILE!=e&&(this.managerInstance.showSmsPopup(e),this.managerInstance.personalMobile=e);var e=BX.prop.getString(t,"NAME",""),i=BX.prop.getString(t,"LAST_NAME","");(e&&this.initialFields.NAME!=e||i&&this.initialFields.LAST_NAME!=i)&&this.changePageTitle(BX.prop.getString(t,"FULL_NAME","")),this.reloadGrid()},reloadGrid:function(){var t;BX.type.isNotEmptyString(this.gridId)&&window.parent.BX.Main.gridManager&&(t=window.parent.BX.Main.gridManager.getById(this.gridId))&&t.instance.reload()},changePageTitle:function(t){t&&(BX.html(BX("pagetitle"),t),document.title=t,BX.getClass("BX.SidePanel.Instance.updateBrowserTitle"))&&BX.SidePanel.Instance.updateBrowserTitle()},showFieldsSettings:function(){BX.SidePanel.Instance.open("intranet:user-pfofile-fields-settings",{contentCallback:function(t){return new Promise(function(e,t){top.BX.ajax.runComponentAction(this.componentName,"fieldsSettings",{signedParameters:this.signedParameters,mode:"class",data:{}}).then(function(t){e({html:t.data.html})})}.bind(this))}.bind(this),width:600})}},BX.load(["/bitrix/js/ui/entity-editor/js/editor.js"],function(){void 0===BX.Intranet.UserProfile.EntityEditorTimezone&&(BX.Intranet.UserProfile.EntityEditorTimezone=function(){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.constructor.apply(this),this._items=null,this._inputAutoTimeZone=null,this._inputTimeZone=null,this._selectAutoTimeZone=null,this._selectTimeZone=null,this._selectContainer=null,this._selectedValue="",this._selectorClickHandler=BX.delegate(this.onSelectorClick,this),this._innerWrapper=null,this._isOpened=!1},BX.Intranet.UserProfile.EntityEditorTimezone.create=function(t,e){var i=new BX.Intranet.UserProfile.EntityEditorTimezone;return i.initialize(t,e),i},BX.extend(BX.Intranet.UserProfile.EntityEditorTimezone,BX.UI.EntityEditorField),BX.Intranet.UserProfile.EntityEditorTimezone.prototype.layout=function(t){var e,i,n,o,r,s,a;this._hasLayout||(this.ensureWrapperCreated({classNames:["ui-entity-card-content-block-field-select"]}),this.adjustWrapper(),this.isNeedToDisplay()&&(this.getName(),e=this.getTitle(),i=this.getValue(),n=this.getTimeZoneItemByValue(i.timeZone),s=this.getAutoTimeZoneItemByValue(i.autoTimeZone),o=this.getDataBooleanParam("isHtml",!1),a={},r={},this._selectedValueAutoTimeZone=i.autoTimeZone,this._selectedValueTimeZone=i.timeZone,this._selectAutoTimeZone=null,this._selectTimeZone=null,this._innerWrapper=null,this._mode===BX.UI.EntityEditorMode.edit?(this._wrapper.appendChild(this.createTitleNode(e)),this._inputAutoTimeZone=BX.create("input",{attrs:{name:"AUTO_TIME_ZONE",type:"hidden",value:i.autoTimeZone}}),this._inputTimeZone=BX.create("input",{attrs:{name:"TIME_ZONE",type:"hidden",value:i.timeZone}}),this._wrapper.appendChild(this._inputAutoTimeZone),this._wrapper.appendChild(this._inputTimeZone),a={props:{className:"ui-ctl-element"}},o?a.html=s?s.NAME:i:a.text=s?s.NAME:i,this._selectAutoTimeZone=BX.create("div",a),BX.bind(this._selectAutoTimeZone,"click",BX.proxy(function(){this._selectorClickHandler("autoTimeZone")},this)),r={props:{className:"ui-ctl-element"}},o?r.html=n?n.NAME:i:r.text=n?n.NAME:i,this._selectTimeZone=BX.create("div",r),BX.bind(this._selectTimeZone,"click",BX.proxy(function(){this._selectorClickHandler("timeZone")},this)),s=BX.create("div",{attrs:{className:"ui-ctl-after ui-ctl-icon-angle"}}),this._selectContainerAutoTimeZone=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w50"},children:[this._selectAutoTimeZone,s]}),this._selectContainerTimeZone=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w50",style:"N"!==i.autoTimeZone?"display: none":""},children:[this._selectTimeZone,BX.clone(s)]}),this._innerWrapper=BX.create("div",{props:{className:"ui-entity-card-content-block-inner"},children:[this._selectContainerAutoTimeZone,this._selectContainerTimeZone]})):(a=function(t){function e(t,e){return t={timeZoneName:"short"==t?"short":"long"},e&&(t.timeZone=e),new Intl.DateTimeFormat([],t).format(new Date).split(" ").slice(1).join(" ")}var i=null;return e("short",i="Y"!=t.autoTimeZone&&t.timeZone?t.timeZone:i)+", "+e("long",i)},this._wrapper.appendChild(this.createTitleNode(e)),r={props:{className:"ui-entity-editor-content-block-text"}},o?r.html=a(i):r.text=a(i),this._textTimeZone=BX.create("div",r),this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},children:[this._textTimeZone]})),this._wrapper.appendChild(this._innerWrapper),this.isContextMenuEnabled())&&this._wrapper.appendChild(this.createContextMenuButton()),this.registerLayout(t),this._hasLayout=!0)},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;return t===BX.UI.EntityEditorMode.edit&&(e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content),e},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getContentWrapper=function(){return this._innerWrapper},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.checkIfNotEmpty=function(t){return""!==t&&"0"!==t},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.doRegisterLayout=function(){},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.doClearLayout=function(t){this.closeMenu(),this._input=null,this._select=null,this._innerWrapper=null},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.refreshLayout=function(){var t,e;this._hasLayout&&(this._isValidLayout?(t=this.getValue(),e=(e=this.getItemByValue(t))?BX.prop.getString(e,"NAME",t):t,this._mode===BX.Intranet.UserProfile.EntityEditorMode.edit?(this._selectedValue=t,this._input&&(this._input.value=t),this._select&&(this._select.innerHTML=this.getDataBooleanParam("isHtml",!1)?e:BX.util.htmlspecialchars(e))):this._mode===BX.Intranet.UserProfile.EntityEditorMode.view&&this._innerWrapper&&(this._innerWrapper.innerHTML=this.getDataBooleanParam("isHtml",!1)?e:BX.util.htmlspecialchars(e))):BX.Intranet.UserProfile.EntityEditorTimezone.superclass.refreshLayout.apply(this,arguments))},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.validate=function(t){if(this._mode!==BX.UI.EntityEditorMode.edit)throw"BX.Intranet.UserProfile.EntityEditorTimezone. Invalid validation context";var e;return!this.isEditable()||(this.clearError(),this.hasValidators()?this.executeValidators(t):((e=!this.isRequired()||""!==BX.util.trim(this._input.value))||(t.addError(BX.Intranet.UserProfile.EntityValidationError.create({field:this})),this.showRequiredFieldError(this._input)),e))},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.showError=function(t,e){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.showError.apply(this,arguments),this._input&&BX.addClass(this._input,"ui-entity-card-content-error")},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.clearError=function(){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.clearError.apply(this),this._input&&BX.removeClass(this._input,"ui-entity-card-content-error")},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onSelectorClick=function(t){this._isOpened?this.closeMenu(t):this.openMenu(t)},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.openMenu=function(t){if(!this._isOpened){for(var e=[],i="timeZone"==t?this.getTimeZoneItems():this.getAutoTimeZoneItems(),n=0,o=i.length;n<o;n++){var r,s=i[n];BX.prop.getBoolean(s,"IS_EDITABLE",!0)&&(r=BX.prop.getString(s,"VALUE",n),s=BX.prop.getString(s,"NAME",r),e.push({text:this.getDataBooleanParam("isHtml",!1)?s:BX.util.htmlspecialchars(s),value:r,onclick:BX.delegate("autoTimeZone"==t?this.onAutoTimeZoneItemSelect:this.onTimeZoneItemSelect,this)}))}var a="timeZone"===t?this._selectTimeZone:this._selectAutoTimeZone;BX.PopupMenu.show(this._id,a,e,{angle:!1,width:a.offsetWidth+"px",maxHeight:300,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}}),BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(a).width)}},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.closeMenu=function(){var t=BX.PopupMenu.getMenuById(this._id);t&&t.popupWindow.close()},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"ui-ctl-active"),this._isOpened=!0},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id),BX.removeClass(this._selectContainer,"ui-ctl-active"),this._isOpened=!1},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onAutoTimeZoneItemSelect=function(t,e){this.closeMenu(),this._selectedValueAutoTimeZone=this._inputAutoTimeZone.value=e.value;e=BX.prop.getString(this.getAutoTimeZoneItemByValue(this._selectedValueAutoTimeZone),"NAME",this._selectedValueAutoTimeZone);this._selectAutoTimeZone.innerHTML=this.getDataBooleanParam("isHtml",!1)?e:BX.util.htmlspecialchars(e),this.markAsChanged(),BX.PopupMenu.destroy(this._id),this._selectContainerTimeZone.style.display="N"===this._selectedValueAutoTimeZone?"block":"none"},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onTimeZoneItemSelect=function(t,e){this.closeMenu(),this._selectedValueTimeZone=this._inputTimeZone.value=e.value;e=BX.prop.getString(this.getTimeZoneItemByValue(this._selectedValueTimeZone),"NAME",this._selectedValueTimeZone);this._selectTimeZone.innerHTML=this.getDataBooleanParam("isHtml",!1)?e:BX.util.htmlspecialchars(e),this.markAsChanged(),BX.PopupMenu.destroy(this._id)},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getTimeZoneItems=function(){return this._itemsAutoTimeZone||(this._itemsAutoTimeZone=BX.prop.getArray(this._schemeElement.getData(),"timezone_items",[])),this._itemsAutoTimeZone},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getAutoTimeZoneItems=function(){return this._itemsTimeZone||(this._itemsTimeZone=BX.prop.getArray(this._schemeElement.getData(),"auto_timezone_items",[])),this._itemsTimeZone},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getTimeZoneItemByValue=function(t){for(var e=this.getTimeZoneItems(),i=0,n=e.length;i<n;i++){var o=e[i];if(t===BX.prop.getString(o,"VALUE",""))return o}return null},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getAutoTimeZoneItemByValue=function(t){for(var e=this.getAutoTimeZoneItems(),i=0,n=e.length;i<n;i++){var o=e[i];if(t===BX.prop.getString(o,"VALUE",""))return o}return null},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getFirstItem=function(){var t=this.getItems();return 0<t.length?t[0]:null},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.save=function(){var t;this.isEditable()&&(t={timeZone:this._selectedValueTimeZone,autoTimeZone:this._selectedValueAutoTimeZone},this._model.setField(this.getName(),t))},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.processModelChange=function(t){BX.prop.get(t,"originator",null)===this||!BX.prop.getBoolean(t,"forAll",!1)&&BX.prop.getString(t,"name","")!==this.getName()||this.refreshLayout()},BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getRuntimeValue=function(){return this._mode===BX.Intranet.UserProfile.EntityEditorMode.edit&&this._input?this._selectedValue:""}),void 0===BX.Intranet.UserProfile.EntityEditorPhone&&(BX.Intranet.UserProfile.EntityEditorPhone=function(){BX.Intranet.UserProfile.EntityEditorPhone.superclass.constructor.apply(this),this._input=null,this._innerWrapper=null},BX.Intranet.UserProfile.EntityEditorPhone.create=function(t,e){var i=new BX.Intranet.UserProfile.EntityEditorPhone;return i.initialize(t,e),i},BX.extend(BX.Intranet.UserProfile.EntityEditorPhone,BX.UI.EntityEditorField),BX.Intranet.UserProfile.EntityEditorPhone.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;return t===BX.UI.EntityEditorMode.edit&&(e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content),e},BX.Intranet.UserProfile.EntityEditorPhone.prototype.getContentWrapper=function(){return this._innerWrapper},BX.Intranet.UserProfile.EntityEditorPhone.prototype.focus=function(){this._input&&(BX.focus(this._input),BX.UI.EditorTextHelper.getCurrent().setPositionAtEnd(this._input))},BX.Intranet.UserProfile.EntityEditorPhone.prototype.layout=function(t){var e,i,n,o;this._hasLayout||(this.ensureWrapperCreated({classNames:["ui-entity-card-content-block-field-phone"]}),this.adjustWrapper(),this.isNeedToDisplay()&&(o=this.getName(),e=this.getTitle(),i=this.getValue(),n=this.checkPhoneIcon(),this._input=null,this._inputContainer=null,this._innerWrapper=null,this.isDragEnabled()&&this._wrapper.appendChild(this.createDragButton()),this._mode===BX.UI.EntityEditorMode.edit?(this._wrapper.appendChild(this.createTitleNode(e)),this._inputContainer=BX.create("div",{attrs:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"}}),this._input=BX.create("input",{attrs:{name:o,className:"ui-ctl-element",type:"text",value:i,id:this._id.toLowerCase()+"_text"}}),this._inputContainer.appendChild(this._input),this.isNewEntity()&&""!==(o=this.getCreationPlaceholder())&&this._input.setAttribute("placeholder",o),BX.bind(this._input,"input",this._changeHandler),this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},children:[this._inputContainer]})):(this._wrapper.appendChild(this.createTitleNode(e)),this.hasContentToDisplay()?this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},children:[BX.create("div",{props:{className:"ui-entity-editor-content-block-text"},children:[BX.create("span",{text:i}),n?BX.create("div",{props:{className:"intranet-user-profile-phone-icon"},events:{mouseup:function(t){t.preventDefault(),t.stopPropagation(),top.BXIM.phoneTo(i)}}}):""]})]}):this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},text:BX.message("UI_ENTITY_EDITOR_FIELD_EMPTY")})),this._wrapper.appendChild(this._innerWrapper),this.isContextMenuEnabled()&&this._wrapper.appendChild(this.createContextMenuButton()),this.isDragEnabled())&&this.initializeDragDropAbilities(),this.registerLayout(t),this._hasLayout=!0)},BX.Intranet.UserProfile.EntityEditorPhone.prototype.checkPhoneIcon=function(t){return"Y"==this._model._settings.SHOW_PHONE_ICON})}))}();